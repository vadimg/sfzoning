<html>
<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120785721-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-120785721-1');
</script>

<title>SF Zoning Laws Make It Illegal To Build Apartments In Most Of The City</title>

<script src="https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css" rel="stylesheet" />
<link href="https://www.mapbox.com/base/latest/base.css" rel="stylesheet" />
<style>

#loader {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  width: 100%;
  background-color: rgba(0,0,0,0.33);
}

h1, h2 {
  background-color: #EBE7E1;
  text-align: center;
}

#container {
  width: 100%;
  height: 100%;

  display: flex;
  flex-flow: column;
}

#map {
  flex-grow: 1;
  flex-shrink: 1;
  flex-basis: auto;
}

.mapboxgl-popup {
  max-width: 400px;
  font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
}

.legend {
  background-color: #fff;
  border-radius: 3px;
  bottom: 30px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
  padding: 10px;
  position: absolute;
  right: 10px;
  z-index: 1;
  width: 300px;
}

.legend h3 {
  margin: 0;
  text-align: center;
}

.legend h5 {
  margin: -3px 0 10px;
  text-align: center;
  font-size: 10px;
}

.legend .legend-item {
  display: block;
  margin-top: 5px;
}

.legend-item span {
  vertical-align: top;
}

.legend-item .percentage {
  width: 50px;
  text-align: right;
  display: inline-block;
  font-size: 10px;
  color: lightgray;
}

.legend .color-box {
  width: 20px;
  height: 20px;
  display: inline-block;
  margin-right: 5px;
  opacity: 0.7;
}

.legend .section {
  margin-top: 10px;
  margin-left: 5px;
  margin-right: 5px;
}

.legend .color-explanation {
  margin-bottom: 10px;
}
.legend .color-explanation p {
  margin: -5px 0;
}

.legend .fineprint p {
  font-size: 10px;
  color: gray;
  margin: 5px 0;
  line-height: 10px;
}
</style>
</head>
<body>
<div id="container">
  <h2>Apartment buildings are illegal to build in 76.4% of San Francisco</h2>
  <div id="map">
    <div id="loader">
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="80px" height="80px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
        <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
        s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
        c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z" />
        <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
        C22.32,8.481,24.301,9.057,26.013,10.047z">
        <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="0.5s" repeatCount="indefinite" />
        </path>
      </svg>
    </div>
  </div>
  <div class="legend">
    <h3>Max. Allowed Homes</h3>
    <h5>(per 2,500 sq ft plot of land)</h5>
    <div class="section color-explanation">
      <p><strong style="color: red">Red</strong> means single-family or duplexes only
      <p><strong style="color: orange">Orange</strong> means triplexes or fourplexes are legal
      <p><strong style="color: green">Green</strong> means larger apartment buildings are legal
    </div>
    <div id="legend-data"></div>
    <div class="fineprint section">
      <p>"Apartment building" is defined to be a building with 3 or more homes. It is illegal to build a building with more than 5 homes in 88.8% of San Francisco.
      <p>2,500 sq ft is a typical lot size in San Francisco
      <p>Assumes 2.5 apartments per 10 ft of height per 2,500 sq ft
      <p>Calculations include <a href="http://sf-planning.org/accessory-dwelling-units" target="_blank">waiverless ADUs</a>
      <p>Many apartment buildings already exist in the red and orange areas but would be illegal to build today
      <p>You can see why new development is concentrated in the Mission, Soma, and Tenderloin neighborhoods
      <p>Data from <a href="http://propertymap.sfplanning.org/" target="_blank">SF gov</a>
    </div>
  </div>
</div>

<!-- templates -->
<div style="display: none">
  <div id="popup-template">
    <h4>Details:</h4>
    {{#compare homes "<=" 0 }}
    {{#compare homes "==" -1 }}
    Open Space
    {{else}}
    <ul class="list-group">
      <li class="list-group-item">No housing allowed - Commercial / Industrial / Office use only</li>
      <li class="list-group-item">Zoning code: {{ zoning }}</li>
    </ul>
    {{/compare}}
    {{else}}
    <ul class="list-group">
      <li class="list-group-item">Homes per 2500 sq ft: {{round homes 3}}</li>
      <li class="list-group-item">Max homes due to zoning code:
        {{#compare homes_zoning ">" 10000 }}
        No limit
        {{else}}
        {{round homes_zoning 3}}
        {{/compare}}
      </li>
      <li class="list-group-item">Max homes due to height limit: {{round homes_height 3}}</li>
      <li class="list-group-item">Zoning code: {{ zoning }}</li>
      <li class="list-group-item">Height limit code: {{ height_str }}</li>
    </ul>
    {{/compare}}
  </div>
  <div id="legend-item-template">
    <div class="legend-item">
      <span class="percentage">
      {{ percentage }}%
      </span>
      <span class="color-box" style="background-color: {{ color }}">
      </span>
      <span>
        {{#compare num ">" 20 }}
        more than 20
        {{else}}{{#compare num "==" -1 }}
        Open Space
        {{else}}{{#compare num "==" 0 }}
        0 (No housing)
        {{else}}
        {{ num }}
        {{/compare}}{{/compare}}{{/compare}}
      </span>
    </div>
  </div>
</div>
<!-- end templates -->

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZGltdmEiLCJhIjoiY2plYzhtMTM5MG5yazJ4bGE0OHZrcHpnZCJ9.u9hqKMLwpq-JHGyhAW2GeQ';

Handlebars.registerHelper('round', function(num, places, options) {
    if (arguments.length < 3) {
      throw new Error("Handlebars Helper round needs 2 parameters");
    }
    var e = Math.pow(10, places);
    return Math.round(num*e) / e;
});

function htmlDecode(input)
{
  var doc = new DOMParser().parseFromString(input, "text/html");
  return doc.documentElement.textContent;
}

Handlebars.registerHelper('compare', function (lvalue, operator, rvalue, options) {

    var operators, result;

    if (arguments.length < 3) {
        throw new Error("Handlerbars Helper 'compare' needs 2 parameters");
    }

    if (options === undefined) {
        options = rvalue;
        rvalue = operator;
        operator = "===";
    }

    operator = htmlDecode(operator);

    operators = {
        '==': function (l, r) { return l == r; },
        '===': function (l, r) { return l === r; },
        '!=': function (l, r) { return l != r; },
        '!==': function (l, r) { return l !== r; },
        '<': function (l, r) { return l < r; },
        '>': function (l, r) { return l > r; },
        '<=': function (l, r) { return l <= r; },
        '>=': function (l, r) { return l >= r; },
        'typeof': function (l, r) { return typeof l == r; }
    };

    if (!operators[operator]) {
        throw new Error("Handlerbars Helper 'compare' doesn't know the operator " + operator);
    }

    result = operators[operator](lvalue, rvalue);

    if (result) {
        return options.fn(this);
    } else {
        return options.inverse(this);
    }

});

var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/streets-v9',
    center: [-122.42936665634733, 37.75967613988033], // starting position
    zoom: 11.75 // starting zoom
});

// Hide loading bar once tiles from geojson are loaded
map.on('data', function(e) {
    if (e.dataType === 'source' && e.sourceId === 'zones-layer') {
        document.getElementById("loader").style.display = "none";
    }
});

// disable map rotation using right click + drag
map.dragRotate.disable();

// disable map rotation using touch rotation gesture
map.touchZoomRotate.disableRotation();

// Add zoom and rotation controls to the map.
map.addControl(new mapboxgl.NavigationControl({showCompass: false}));

var popupTemplate = Handlebars.compile(document.getElementById("popup-template").innerHTML);
var legendItemTemplate = Handlebars.compile(document.getElementById("legend-item-template").innerHTML);

var KEY_DATA = [
  {
    "color": "gray",
    "homes": -1,
    "percentage": 28.14133485478517
  },
  {
    "color": "#3b0000",
    "homes": 0,
    "percentage": 10.132729193442064
  },
  {
    "color": "#950004",
    "homes": 1,
    "percentage": 7.550141036078164
  },
  {
    "color": "#c60003",
    "homes": 2,
    "percentage": 30.588595770638435
  },
  {
    "color": "#ff6e00",
    "homes": 3,
    "percentage": 9.342418223095939
  },
  {
    "color": "#ffbb00",
    "homes": 4,
    "percentage": 2.9721895542919547
  },
  {
    "color": "#ffff00",
    "homes": 5,
    "percentage": 0.0437868259174081
  },
  {
    "color": "#deec00",
    "homes": 6,
    "percentage": 1.5815828228416848
  },
  {
    "color": "#bed900",
    "homes": 7,
    "percentage": 0.0661619294781416
  },
  {
    "color": "#9ec500",
    "homes": 10,
    "percentage": 2.0784316765302364
  },
  {
    "color": "#7eb100",
    "homes": 12,
    "percentage": 2.572165352788064
  },
  {
    "color": "#609e00",
    "homes": 15,
    "percentage": 1.1895356703836375
  },
  {
    "color": "#428c00",
    "homes": 17,
    "percentage": 0.026353291847127265
  },
  {
    "color": "#207700",
    "homes": 20,
    "percentage": 0.5505510923624533
  },
  {
    "color": "#006400",
    "homes": 22,
    "percentage": 3.135933756049525
  }
];

map.on('load', function () {
  map.addLayer({
      'id': 'zones-layer',
      'type': 'fill',
      'source': {
          'type': 'geojson',
          'data': 'generated/res2.geojson'
      },
      'paint': {
          'fill-opacity': 0.7,
          'fill-color': ['get', 'fill']
      }
  });

    // When a click event occurs on a feature in the states layer, open a popup at the
    // location of the click, with description HTML from its properties.
    map.on('click', 'zones-layer', function (e) {
      var prop = e.features[0].properties;
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(popupTemplate(prop))
            .addTo(map);
    });

    var legend = document.getElementById('legend-data');

    KEY_DATA.forEach(function(data) {
      var roundedPercentage = Math.round(10*data['percentage'])/10;
      if (roundedPercentage == 0) {
        return;
      }
      legend.insertAdjacentHTML('beforeend', legendItemTemplate({
            num: Math.round(data['homes']*1000)/1000,
            percentage: roundedPercentage.toFixed(1),
            color: data['color']
      }));
    });
});

</script>
</body>
</html>
